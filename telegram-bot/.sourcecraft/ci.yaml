tokens:
  SERVICE_CONNECTION:
    service_connection: default-service-connection
    scope: org
env:
  id_token: ${{ tokens.SERVICE_CONNECTION.id_token}}
  yc_sa_id: ${{ tokens.SERVICE_CONNECTION.service_account_id }}
  yc_folder_id: ${{ tokens.SERVICE_CONNECTION.folder_id }}
on:
  push:
    - workflows: demo-service-connection-workflow

tokens:
  SERVICE_CONNECTION:
    service_connection: default-service-connection
    scope: org

workflows:
  demo-service-connection-workflow:
    tasks:
      - name: demo-task
        cubes:
          # Возвращает IAM-токен через outputs.IAM_TOKEN
          - name: get-iam-token
            env:
              ID_TOKEN: ${{ tokens.SERVICE_CONNECTION.id_token }}
              YC_SA_ID: ${{ tokens.SERVICE_CONNECTION.service_account_id }}
            image: cr.yandex/sourcecraft/yc-iam:latest
          
          # Пример использования с Yandex Cloud CLI
          - name: yc-cli-demo
            env:  
              YC_FOLDER_ID: ${{ tokens.SERVICE_CONNECTION.folder_id }}
              YC_IAM_TOKEN: ${{ cubes.get-iam-token.outputs.IAM_TOKEN }}
            image: 
              name: cr.yandex/sourcecraft/yc-cli:latest
              entrypoint: ""
            script:
              - |
                yc config set folder-id $YC_FOLDER_ID
                yc serverless function list
