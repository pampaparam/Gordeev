- name: deploy-telegram-bot
  needs: [get-iam-token]
  env:
    YC_IAM_TOKEN: ${{ cubes.get-iam-token.outputs.IAM_TOKEN }}
    YC_FOLDER_ID: ${{ tokens.SERVICE_CONNECTION.folder_id }}
    SECRET_ID: "e6qcj6va08niqcelksac"  # Ваш секрет
  image: cr.yandex/sourcecraft/yc-cli:latest
  script:
    - yc config set folder-id $YC_FOLDER_ID
    - yc config set iam-token $YC_IAM_TOKEN
    - |
      yc serverless function create-or-update telegram-bot \
        --runtime python312 \
        --memory 128MB \
        --exec-timeout 5s \
        --secret-ids $SECRET_ID \
        --entrypoint handler
    - |
      yc serverless function version create-or-update telegram-bot \
        --source-path . \
        --runtime python312
    - |
      FUNCTION_URL=$(yc serverless function url-https-trigger create \
        --function-name telegram-bot --public --format json | jq -r .url)
      echo "Function URL: $FUNCTION_URL"
    - |
      curl -X POST "https://api.telegram.org/bot8430017466:AAEW71rfyYUZCAiZibHgISVj3w6glwebdNI/setWebhook?url=$FUNCTION_URL"

