name: Deploy Bot to Yandex Cloud
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.0
        
    - name: Terraform Init & Apply
      env:
        YC_TOKEN: ${{ secrets.YANDEX_TOKEN }}
        YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
        YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
      run: |
        terraform init
        terraform apply -auto-approve
    
    - name: Get VM IP
      id: terraform-output
      run: echo "vm_ip=$(terraform output -raw vm_ip)" >> $GITHUB_OUTPUT
    
    - name: Deploy with Ansible
      uses: dawidd6/action-ansible-playbook@v2
      with:
        playbook: deploy-bot.yml
        inventory: |
          bot-vm:
            ansible_host: ${{ steps.terraform-output.outputs.vm_ip }}
            ansible_user: debian
        options: >-
          --private-key ${{ secrets.SSH_PRIVATE_KEY }}
          --extra-vars "AlexiusGordeev=Gordeev/telegram-bot AlexiusGordeev/Gordeev/test/.github/workflows/tg-bot"
      env:
        ANSIBLE_HOST_KEY_CHECKING: false
